{% extends 'base.html' %}

{% block title %}
{% if category %}{{ category.name }}{% else %}Products{% endif %} | E-Shop
{% endblock %}

{% block content %}

<!-- Shop Header -->
<div class="bg-gray-100 p-8 rounded-lg mb-8">
  <div class="container mx-auto flex flex-col md:flex-row items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">
        {% if category %}{{ category.name }}{% else %}All Products{% endif %}
      </h1>
      <p class="text-gray-600 mt-1">
        Showing {{ products|length }} product{{ products|length|pluralize }}
        {% if request.GET.search %}
          for "{{ request.GET.search }}"
        {% endif %}
      </p>
    </div>

    {% if request.GET.min_price or request.GET.max_price or request.GET.rating or request.GET.search %}
    <div class="mt-4 md:mt-0 flex flex-wrap items-center gap-2">
      {% if request.GET.min_price or request.GET.max_price %}
      <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">
        Price: ৳{{ request.GET.min_price|default:min_price }} - ৳{{ request.GET.max_price|default:max_price }}
      </span>
      {% endif %}

      {% if request.GET.rating %}
      <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">
        Rating: {{ request.GET.rating }}+ stars
      </span>
      {% endif %}

      {% if request.GET.search %}
      <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">
        Search: "{{ request.GET.search }}"
      </span>
      {% endif %}

      <a href="{% url 'product_list' %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
        <i class="fas fa-times-circle"></i> Clear All
      </a>
    </div>
    {% endif %}
  </div>
</div>

<div class="container mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

  <!-- Sidebar -->
  <aside class="lg:col-span-3 sticky top-20">
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-lg font-semibold flex items-center mb-4">
        <i class="fas fa-filter mr-2"></i> Filter Products
      </h2>

      <form method="get" class="space-y-6">

        <!-- Categories -->
        <div>
          <h3 class="text-gray-700 font-medium mb-2 border-b pb-2">Categories</h3>
          <a href="{% url 'product_list' %}"
             class="block py-1 px-2 rounded hover:bg-gray-100 {% if not category %}bg-blue-100 font-semibold{% endif %}">
            All Categories
          </a>

          <div class="ml-2 mt-2 space-y-1">
            {% for c in categories %}
            <a href="{% url 'product_list_by_category' c.slug %}"
               class="block py-1 px-2 rounded hover:bg-gray-100 {% if category and category.slug == c.slug %}bg-blue-100 font-semibold{% endif %}">
              {{ c.name }}
            </a>
            {% endfor %}
          </div>
        </div>

        <!-- Price -->
        <div>
          <h3 class="text-gray-700 font-medium mb-2 border-b pb-2">Price Range</h3>
          <div class="flex gap-2 mb-2">
            <input type="number" name="min_price" placeholder="Min"
              value="{{ request.GET.min_price|default:'' }}"
              class="w-1/2 border rounded px-2 py-1">
            <input type="number" name="max_price" placeholder="Max"
              value="{{ request.GET.max_price|default:'' }}"
              class="w-1/2 border rounded px-2 py-1">
          </div>
        </div>

        <!-- Rating -->
        <div>
          <h3 class="text-gray-700 font-medium mb-2 border-b pb-2">Rating</h3>
          <select name="rating" class="w-full border rounded px-2 py-1">
            <option value="">Any Rating</option>
            <option value="5" {% if request.GET.rating == '5' %}selected{% endif %}>★★★★★</option>
            <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>★★★★☆</option>
            <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>★★★☆☆</option>
            <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>★★☆☆☆</option>
            <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>★☆☆☆☆</option>
          </select>
        </div>

        {% if request.GET.search %}
        <input type="hidden" name="search" value="{{ request.GET.search }}">
        {% endif %}

        <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
          Apply Filters
        </button>
      </form>
    </div>
  </aside>

  <!-- Products -->
  <main class="lg:col-span-9">
    {% if products %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      {% for product in products %}
      <div class="bg-white rounded-lg shadow-md overflow-hidden group">

        <div class="h-52 overflow-hidden relative">
          {% if product.images.exists %}
            {% with img=product.images.first %}
            <img src="{{ img.image.url }}" alt="{{ product.name }}"
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
            {% endwith %}
          {% else %}
            <div class="h-full flex items-center justify-center bg-gray-100">
              <i class="fas fa-image text-gray-400 text-3xl"></i>
            </div>
          {% endif %}
        </div>

        <div class="p-4">
          <h5 class="font-semibold text-lg">{{ product.name }}</h5>
          <p class="text-gray-500 text-sm">{{ product.description|truncatechars:80 }}</p>

          <div class="flex justify-between items-center mt-2">
            <span class="font-bold">৳{{ product.price }}</span>
            <div class="text-yellow-400">
              {% for i in "12345" %}
                {% if forloop.counter <= product.average_rating %}
                  <i class="fas fa-star"></i>
                {% else %}
                  <i class="far fa-star"></i>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <a href="{% url 'product_detail' product.slug %}"
             class="block mt-3 text-center bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
            View Details
          </a>
        </div>
      </div>
      {% endfor %}

    </div>
    {% else %}
      <p class="text-center text-gray-500">No products found.</p>
    {% endif %}
  </main>
</div>

{% endblock %}
